#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - fail2ban
  - chrony
  - ufw
  - curl
  - wget
  - git

users:
  - name: deploy
    groups: docker
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ${ssh_public_key}

runcmd:
  # Docker ohne sudo
  - usermod -aG docker deploy
  
  # Firewall konfigurieren
  - ufw allow OpenSSH
  - ufw allow 80/tcp
  - ufw allow 443/tcp  
  - ufw allow 3000/tcp
  - ufw allow 9090/tcp
  - ufw allow 9100/tcp
  - ufw --force enable
  
  # Fail2ban einrichten
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Chrony fÃ¼r Zeit-Sync
  - systemctl enable chrony
  - systemctl start chrony
  
  # Automatische Updates
  - echo 'Unattended-Upgrade::Allowed-Origins {"${distro_id}:${distro_codename}-security";}' > /etc/apt/apt.conf.d/50unattended-upgrades
  - echo 'Unattended-Upgrade::Automatic-Reboot "true";' >> /etc/apt/apt.conf.d/50unattended-upgrades
  
  # Docker beim Starten
  - systemctl enable docker
  - systemctl start docker

final_message: "RobinCore Server setup completed after $UPTIME seconds"
